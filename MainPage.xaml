using CommunityToolkit.Maui.Media;
using CommunityToolkit.Maui.Views;
using System.Collections.ObjectModel;
using System.Text.Json;

namespace MauiApp2
{
    public partial class MainPage : ContentPage
    {
        private ObservableCollection<SongModel> _songs = new();
        private readonly string _songsFilePath = Path.Combine(FileSystem.AppDataDirectory, "songs.json");
        private int _currentIndex = -1;

        public MainPage()
        {
            InitializeComponent();
            SongsCollectionView.ItemsSource = _songs;
            _ = LoadSongsAsync();
        }

        private async void Add_Button_Clicked(object sender, EventArgs e)
        {
            try
            {
                var result = await FilePicker.PickMultipleAsync(new PickOptions
                {
                    PickerTitle = "Wybierz pliki muzyczne",
                    FileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
                    {
                        { DevicePlatform.WinUI, new[] { ".mp3", ".wav", ".flac" } },
                        { DevicePlatform.Android, new[] { "audio/*" } },
                        { DevicePlatform.iOS, new[] { "public.audio" } }
                    })
                });

                if (result != null)
                {
                    foreach (var file in result)
                    {
                        _songs.Add(new SongModel
                        {
                            Title = Path.GetFileNameWithoutExtension(file.FileName),
                            Path = file.FullPath
                        });
                    }
                }
                await SaveSongsAsync();
            }
            catch (Exception ex)
            {
                await DisplayAlert("Błąd", $"Nie udało się wybrać plików: {ex.Message}", "OK");
            }
        }

        private async Task SaveSongsAsync()
        {
            try
            {
                var json = JsonSerializer.Serialize(_songs);
                await File.WriteAllTextAsync(_songsFilePath, json);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd zapisu piosenek: {ex.Message}");
            }
        }

        private async Task LoadSongsAsync()
        {
            try
            {
                if (File.Exists(_songsFilePath))
                {
                    var json = await File.ReadAllTextAsync(_songsFilePath);
                    var loadedSongs = JsonSerializer.Deserialize<ObservableCollection<SongModel>>(json);

                    if (loadedSongs != null)
                    {
                        _songs.Clear();
                        foreach (var song in loadedSongs)
                            _songs.Add(song);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd odczytu piosenek: {ex.Message}");
            }
        }

        private void PlayCurrentSong()
        {
            if (_currentIndex < 0 || _currentIndex >= _songs.Count) return;

            Player.Source = _songs[_currentIndex].Path;
            Player.Play();
            CurrentSongLabel.Text = $"▶ {_songs[_currentIndex].Title}";
        }

        private void PauseButton_Clicked(object sender, EventArgs e)
        {
            if (_currentIndex < 0 || _currentIndex >= _songs.Count) return;

            if (Player.CurrentState == MediaElementState.Playing)
            {
                Player.Pause();
                CurrentSongLabel.Text = $"⏸ {_songs[_currentIndex].Title}";
            }
            else if (Player.CurrentState == MediaElementState.Paused)
            {
                Player.Play();
                CurrentSongLabel.Text = $"▶ {_songs[_currentIndex].Title}";
            }
            else
            {
                DisplayAlert("Info", "Brak odtwarzania do wznowienia.", "OK");
            }
        }

        private void NextButton_Clicked(object sender, EventArgs e)
        {
            if (_songs.Count == 0) return;
            _currentIndex = (_currentIndex + 1) % _songs.Count;
            PlayCurrentSong();
        }

        private void PrevButton_Clicked(object sender, EventArgs e)
        {
            if (_songs.Count == 0) return;
            _currentIndex = (_currentIndex - 1 + _songs.Count) % _songs.Count;
            PlayCurrentSong();
        }

        private void ShuffleButton_Clicked(object sender, EventArgs e)
        {
            if (_songs.Count == 0) return;
            var random = new Random();
            _currentIndex = random.Next(_songs.Count);
            PlayCurrentSong();
        }

        private async void DeleteButton_Clicked(object sender, EventArgs e)
        {
            if (sender is ImageButton button && button.CommandParameter is SongModel song)
            {
                bool confirm = await DisplayAlert("Usuń utwór", $"Czy na pewno chcesz usunąć \"{song.Title}\"?", "Tak", "Nie");
                if (confirm)
                {
                    int indexToRemove = _songs.IndexOf(song);
                    _songs.Remove(song);

                    if (indexToRemove == _currentIndex)
                    {
                        Player.Stop();
                        CurrentSongLabel.Text = "Brak utworu";
                        _currentIndex = -1;
                    }
                    else if (indexToRemove < _currentIndex)
                    {
                        _currentIndex--;
                    }

                    await SaveSongsAsync();
                }
            }
        }
    }

    public class SongModel
    {
        public string Title { get; set; } = string.Empty;
        public string Path { get; set; } = string.Empty;
    }
}
